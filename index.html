<html>

<head>
    <title>Please, save Egor</title>
    <link rel="stylesheet" href="./resources/styles.css">
</head>

<body>
    <div class="background" style="top: 0vh; left: -2vw;"></div>
    <div class="screen menu">
        <div class="rank_table">
            <table class="ranks">
                <tr style="background-color: #fff; color: #000; font-weight: bold;">
                    <td>#</td>
                    <td>Имя</td>
                    <td>Очки</td>
                </tr>
            </table>
        </div>
        <div class="input_area">
            <h1 class="input_area_title">Спаси Егорку!</h1>
            <input class="name" type="text" placeholder="Имя" maxlength="60" spellcheck="false">
            <div class="start_btn">Начать</div>
        </div>
    </div>
    <div class="screen game hide">
        <h1 class="score">0</h1>
        <div class="egor" style="top: 0px; left: 0px;"></div>
    </div>
    <script src="resources/jquery.min.js"></script>
    <script>
        let fps = 60;
        let max_enemy_amount = 20;
        let egor_start_speed = 550;
        let enemy_start_speed = 300;
        let min_x = 10;
        let max_x = $(document).width() - 100;
        let min_y = -10;
        let max_y = $(document).height() - 130;
        let preload = heroArray = [
            './resources/images/egor_up.png',
            './resources/images/egor_up2.png',
            './resources/images/egor_up3.png',
            './resources/images/egor_walk.png',
            './resources/images/egor_walk2.png',
            './resources/images/egor_walk3.png',
            './resources/images/lizab1.png',
            './resources/images/lizab2.png',
            './resources/images/lizab3.png',
            './resources/images/lizab4.png',
            './resources/images/lizaw1.png',
            './resources/images/lizaw2.png',
            './resources/images/lizaw3.png',
            './resources/images/lizaw4.png',
            './resources/images/serg1.png',
            './resources/images/serg2.png',
            './resources/images/serg3.png',
            './resources/images/serg4.png',
        ];
        let back_music = new Audio('./resources/music/music.mp3');
        back_music.loop = true;

        let death_sound = new Audio('./resources/music/hitt1.mp3');
        let condemnation_sound = new Audio('./resources/music/condemnation.mp3');

        let name = '';
        let score = 0;
        let egor_speed = egor_start_speed;
        let egor_x = ($(document).width() - $(".egor").width()) / 2;
        let egor_y = 0;
        let egor_x_delta = 0;
        let egor_y_delta = 0;


        let main_interval, enemy_interval;

        $(window).on('load', function() {
            preload.forEach(function(resource) {
                let img = new Image();
                img.src = resource;
            });


        });

        $(document).on('keydown', function(e) {
            if (e.which == 38) {
                egor_y_delta = -1;
            } else if (e.which == 40) {
                egor_y_delta = 1;
            } else if (e.which == 37) {
                egor_x_delta = -1;
            } else if (e.which == 39) {
                egor_x_delta = 1;
            }
        });

        $(document).on('keyup', function(e) {
            if ((e.which == 38 && egor_y_delta < 0) ||
                (e.which == 40 && egor_y_delta > 0)) {
                egor_y_delta = 0;
            }

            if ((e.which == 37 && egor_x_delta < 0) ||
                (e.which == 39 && egor_x_delta > 0)) {
                egor_x_delta = 0;
            }
        });

        function addEnemy(name, height, side, x, y, speed) {
            if (side) {
                side = $(window).width() + 115;
            } else {
                side = -115;
            }

            let dist = Math.sqrt((y - height) * (y - height) + (x - side) * (x - side));
            x = (x - side) / dist * speed;
            y = (y - height) / dist * speed;

            let rotation = Math.atan2(-y, -x);
            rotation = rotation * 180 / Math.PI;

            $(".screen").append('<div class="enemy ' + name + '" style="' +
                'transform: rotate(' + rotation + 'deg)' + (side < 0 ? ' scaleY(-1)' : '') + ';' +
                'top:' + height + 'px;' +
                'left:' + side + 'px;' +
                '" speedx="' + x + '" speedy="' + y + '"></div>')
        }

        function addScore(name, score) {
            $.ajax({
                url: "https://cergmin.pythonanywhere.com/add/" +
                    name + "/" + "/" + score,
                success: function(data) {
                    console.log(data);
                    reloadRankTable();
                }
            });
        }

        function reloadRankTable() {
            $.ajax({
                url: "https://cergmin.pythonanywhere.com",
                success: function(data) {
                    data = JSON.parse(data);
                    $(".ranks").html('<tr style="background-color: #fff; color: #000; font-weight: bold;"><td>#</td><td>Имя</td><td>Очки</td></tr>');

                    let flag = true;

                    data.forEach(function(item, i) {

                        if (item['name'] == name) {
                            flag = false;
                            $(".ranks").append('<tr style="background-color: #cd4040;">' +
                                '<td>' + (i + 1) + '</td>' +
                                '<td>' + item['name'] + '</td>' +
                                '<td>' + item['score'] + '</td></tr>');
                        } else {
                            $(".ranks").append('<tr>' +
                                '<td>' + (i + 1) + '</td>' +
                                '<td>' + item['name'] + '</td>' +
                                '<td>' + item['score'] + '</td></tr>');
                        }
                    });

                    if (flag && name != '') {
                        $('.ranks').append('<tr><td>...</td><td>...</td><td>...</td></tr><tr style="background-color: #cd4040;">' +
                            '<td></td>' +
                            '<td>' + name + '</td>' +
                            '<td>' + score + '</td></tr>');
                    }
                }
            });
        }
        reloadRankTable();
        setInterval(reloadRankTable, 5000);

        $(".start_btn").on('click', start);

        function start() {
            if ($(".name").val().length > 0) {
                $.ajax({
                    url: "https://cergmin.pythonanywhere.com/check_ip/" + $(".name").val(),
                    success: function(data) {
                        if (data == 'ok') {
                            name = $(".name").val();

                            $(".screen.menu").addClass('hide');
                            $(".screen.game").removeClass('hide');

                            run_game();
                        } else {
                            $(".input_area_title").html("Имя занято");
                        }
                    }
                });
            } else {
                $(".input_area_title").html("Введите имя");
            }
        }

        function run_game() {
            score = 0;
            egor_speed = egor_start_speed;
            egor_x = ($(document).width() - $(".egor").width()) / 2;
            egor_y = 0;
            egor_x_delta = 0;
            egor_y_delta = 0;

            $(".score").html('0');
            back_music.play();
            death_sound.pause();
            death_sound.currentTime = 0;
            condemnation_sound.pause();
            condemnation_sound.currentTime = 0;

            reloadRankTable();
            main_interval = setInterval(function() {
                if (egor_x_delta != 0 && egor_y_delta != 0) {
                    if ((egor_x_delta < 0 && egor_x > min_x) || (egor_x_delta > 0 && egor_x < max_x)) {
                        egor_x += egor_x_delta * egor_speed / fps / Math.sqrt(2);
                    }
                    if ((egor_y_delta < 0 && egor_y > min_y) || (egor_y_delta > 0 && egor_y < max_y)) {
                        egor_y += egor_y_delta * egor_speed / fps / Math.sqrt(2);
                    }
                } else {
                    if ((egor_x_delta < 0 && egor_x > min_x) || (egor_x_delta > 0 && egor_x < max_x)) {
                        egor_x += egor_x_delta * egor_speed / fps;
                    }
                    if ((egor_y_delta < 0 && egor_y > min_y) || (egor_y_delta > 0 && egor_y < max_y)) {
                        egor_y += egor_y_delta * egor_speed / fps;
                    }
                }

                $(".egor").attr("style", "top: " + egor_y + "px; left: " + egor_x + "px;");
                if (egor_x_delta < 0) {
                    $(".egor").attr("class", "egor left");
                } else if (egor_x_delta > 0) {
                    $(".egor").attr("class", "egor right");
                } else if (egor_y_delta > 0) {
                    $(".egor").attr("class", "egor down");
                } else if (egor_y_delta < 0) {
                    $(".egor").attr("class", "egor up");
                } else {
                    $(".egor").attr("class", "egor");
                }

                for (let i = 0; i < $(".screen > .enemy").length; i++) {
                    let obj = $(".screen > .enemy").eq(i);
                    let top = parseFloat(obj.css('top').substr(0, obj.css('top').length - 2)) + obj.attr("speedy") / fps;
                    let left = parseFloat(obj.css('left').substr(0, obj.css('left').length - 2)) + obj.attr("speedx") / fps;

                    if ((top < -120) || (top > $(window).height() + 120) || (left < -120) || (left > $(window).width() + 120)) {
                        obj.remove();
                        i--;
                        continue;
                    }
                    obj.attr("style", 'transform: ' + obj.css('transform') + ';top:' + top + 'px;' + 'left:' + left + 'px;');

                    if (Math.sqrt(((top - egor_y) * (top - egor_y) + (left - egor_x) * (left - egor_x))) < 90) {
                        die();
                    }
                }

                $(".background").attr("style", "top: " + (((max_y - egor_y) / max_y - 1) * 4) + "vh; left: " + (((max_x - egor_x) / max_x - 1) * 4) + "vw;")
            }, 1000 / fps);

            enemy_interval = setInterval(function() {
                if ($(".screen > .enemy").length < max_enemy_amount) {
                    addEnemy(
                        ['foxford', 'lizobakt', 'foxford', 'srja', 'lizobakt', 'srja'][Math.floor(Math.random() * 6)],
                        Math.round(Math.random() * $(window).height()),
                        Math.round(Math.random()),
                        egor_x + Math.random() * 500 - 250,
                        egor_y + Math.random() * 500 - 250,
                        enemy_start_speed + score * 2);
                    egor_speed = egor_start_speed + score;

                    score++;
                    $('.score').html(score);
                }
                // $('.score').html(score + " (" + $(".screen > .enemy").length + ")");
            }, 400 - Math.min(300, score * 5));
        }

        function die() {
            clearInterval(main_interval);
            clearInterval(enemy_interval);

            back_music.pause();
            back_music.currentTime = 0;
            death_sound.play();
            condemnation_sound.play();

            for (let i = 0; i < $(".screen > .enemy").length; i++) {
                let obj = $(".screen > .enemy").eq(i);
                obj.remove();
                i--;
            }

            $(".input_area_title").html("Тебя кокнули");

            $(".screen.menu").removeClass('hide');
            $(".screen.game").addClass('hide');

            addScore(name, score);
        }
    </script>
</body>

</html>