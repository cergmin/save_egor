<html>

<head>
    <title>Please, save Egor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./resources/styles.css">
</head>

<body>
    <div class="background" style="top: 0vh; left: -2vw;"></div>
    <div class="screen">
        <h1 class="score">0</h1>
        <div class="egor" style="top: 0px; left: 0px;"></div>
    </div>
    <script src="resources/jquery.min.js"></script>
    <script>
        let fps = 60;
        let max_enemy_amount = 10;
        let egor_speed = 550;
        let min_x = 10;
        let max_x = $(document).width() - 100;
        let min_y = -10;
        let max_y = $(document).height() - 130;
        let preload = heroArray = [
            './resources/images/egor_up.png',
            './resources/images/egor_up2.png',
            './resources/images/egor_up3.png',
            './resources/images/egor_walk.png',
            './resources/images/egor_walk2.png',
            './resources/images/egor_walk3.png',
            './resources/images/lizab1.png',
            './resources/images/lizab2.png',
            './resources/images/lizab3.png',
            './resources/images/lizab4.png',
            './resources/images/lizaw1.png',
            './resources/images/lizaw2.png',
            './resources/images/lizaw3.png',
            './resources/images/lizaw4.png',
            './resources/images/serg1.png',
            './resources/images/serg2.png',
            './resources/images/serg3.png',
            './resources/images/serg4.png',
        ];

        let score = 0;
        let egor_x = ($(document).width() - $(".egor").width()) / 2;
        let egor_y = 0;
        let egor_x_delta = 0;
        let egor_y_delta = 0;

        $(window).on('load', function() {
            preload.forEach(function(resource) {
                let img = new Image();
                img.src = resource;
            });
        });

        $(document).on('keydown', function(e) {
            if (e.which == 38) {
                egor_y_delta = -1;
            } else if (e.which == 40) {
                egor_y_delta = 1;
            } else if (e.which == 37) {
                egor_x_delta = -1;
            } else if (e.which == 39) {
                egor_x_delta = 1;
            }
        });

        $(document).on('keyup', function(e) {
            if ((e.which == 38 && egor_y_delta < 0) ||
                (e.which == 40 && egor_y_delta > 0)) {
                egor_y_delta = 0;
            }

            if ((e.which == 37 && egor_x_delta < 0) ||
                (e.which == 39 && egor_x_delta > 0)) {
                egor_x_delta = 0;
            }
        });

        function addEnemy(name, height, side, x, y, speed) {
            if (side) {
                side = $(window).width() + 115;
            } else {
                side = -115;
            }

            let dist = Math.sqrt((y - height) * (y - height) + (x - side) * (x - side));
            x = (x - side) / dist * speed;
            y = (y - height) / dist * speed;

            let rotation = Math.atan2(-y, -x);
            rotation = rotation * 180 / Math.PI;

            console.log(rotation);

            $(".screen").append('<div class="enemy ' + name + '" style="' +
                'transform: rotate(' + rotation + 'deg)' + (side < 0 ? ' scaleY(-1)' : '') + ';' +
                'top:' + height + 'px;' +
                'left:' + side + 'px;' +
                '" speedx="' + x + '" speedy="' + y + '"></div>')
        }

        setInterval(function() {
            if (egor_x_delta != 0 && egor_y_delta != 0) {
                if ((egor_x_delta < 0 && egor_x > min_x) || (egor_x_delta > 0 && egor_x < max_x)) {
                    egor_x += egor_x_delta * egor_speed / fps / Math.sqrt(2);
                }
                if ((egor_y_delta < 0 && egor_y > min_y) || (egor_y_delta > 0 && egor_y < max_y)) {
                    egor_y += egor_y_delta * egor_speed / fps / Math.sqrt(2);
                }
            } else {
                if ((egor_x_delta < 0 && egor_x > min_x) || (egor_x_delta > 0 && egor_x < max_x)) {
                    egor_x += egor_x_delta * egor_speed / fps;
                }
                if ((egor_y_delta < 0 && egor_y > min_y) || (egor_y_delta > 0 && egor_y < max_y)) {
                    egor_y += egor_y_delta * egor_speed / fps;
                }
            }

            $(".egor").attr("style", "top: " + egor_y + "px; left: " + egor_x + "px;");
            if (egor_x_delta < 0) {
                $(".egor").attr("class", "egor left");
            } else if (egor_x_delta > 0) {
                $(".egor").attr("class", "egor right");
            } else if (egor_y_delta > 0) {
                $(".egor").attr("class", "egor down");
            } else if (egor_y_delta < 0) {
                $(".egor").attr("class", "egor up");
            } else {
                $(".egor").attr("class", "egor");
            }

            for (let i = 0; i < $(".screen > .enemy").length; i++) {
                let obj = $(".screen > .enemy").eq(i);
                let top = parseFloat(obj.css('top').substr(0, obj.css('top').length - 2)) + obj.attr("speedy") / fps;
                let left = parseFloat(obj.css('left').substr(0, obj.css('left').length - 2)) + obj.attr("speedx") / fps;

                if ((top < -120) || (top > $(window).height() + 120) || (left < -120) || (left > $(window).width() + 120)) {
                    obj.remove();
                    i--;
                    continue;
                }
                obj.attr("style", 'transform: ' + obj.css('transform') + ';top:' + top + 'px;' + 'left:' + left + 'px;');
            }

            $(".background").attr("style", "top: " + (((max_y - egor_y) / max_y - 1) * 4) + "vh; left: " + (((max_x - egor_x) / max_x - 1) * 4) + "vw;")
        }, 1000 / fps);

        setInterval(function() {
            if ($(".screen > .enemy").length < max_enemy_amount) {
                addEnemy(
                    ['foxford', 'lizobakt', 'foxford', 'srja', 'lizobakt', 'srja'][Math.floor(Math.random() * 6)],
                    Math.round(Math.random() * $(window).height()),
                    Math.round(Math.random()),
                    egor_x,
                    egor_y,
                    200);

                score++;
                $('.score').html(score);
            }
        }, 500);
    </script>
</body>

</html>